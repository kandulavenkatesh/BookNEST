doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Book Details - #{book.title}

    link(
      rel="stylesheet",
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    )

    style.
      body {
        background: linear-gradient(120deg, #f8fafc 0%, #eef2ff 50%, #f8fafc 100%);
        color: #334155;
      }
      .card-soft {
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        box-shadow: 0 12px 32px rgba(15,23,42,0.08);
      }
      .label-pill {
        border-radius: 999px;
        padding: 6px 12px;
        background: rgba(14,165,233,0.12);
        color: #0ea5e9;
        font-weight: 600;
      }

  body
    .container.py-4.py-lg-5

      // ===== HEADER =====
      .d-flex.justify-content-between.align-items-center.mb-4
        .d-flex.align-items-center.gap-3
          span.label-pill Details
          h1.h4.fw-bold.mb-0 #{book.title}

          if avg && avg.total > 0
            span.badge.bg-warning.text-dark
              | ‚≠ê #{Number(avg.avgRating).toFixed(1)} / 5 (#{avg.total})
          else
            span.text-muted No ratings yet

        .d-flex.gap-2
          a.btn.btn-outline-secondary.rounded-pill(href="/dashboard") ‚Üê Back
          a.btn.btn-outline-primary.rounded-pill(href="/") Home

          if uid === 1
            a.btn.btn-warning.rounded-pill(href=`/admin/books/update/${book.id}`) ‚úèÔ∏è Update
            a.btn.btn-danger.rounded-pill(
              href=`/admin/books/delete/${book.id}`
              onclick="return confirm('Delete this book?')"
            ) üóë Delete

      // ===== CONTENT =====
      .row.g-4

        // ===== LEFT =====
        .col-lg-4
          .card.card-soft.p-3
            img.rounded.w-100.mb-3(
              src=book.cover_image_url || 'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f'
              style="height:320px; object-fit:cover"
            )

            .small.text-muted ISBN-13: #{book.isbn_13 || '‚Äî'}
            .small.text-muted ISBN-10: #{book.isbn_10 || '‚Äî'}
            .small.text-muted Publisher: #{book.publisher_name || '‚Äî'}
            .small.text-muted Language: #{book.language || '‚Äî'}
            .small.text-muted Format: #{book.format || '‚Äî'}
            .small.text-muted Pages: #{book.page_count || '‚Äî'}

            if book.book_upload
              a.btn.btn-primary.w-100.mt-3(
                href=book.book_upload
                target="_blank"
              ) üìò View Book (PDF)
            else
              p.text-muted.mt-3.text-center No PDF available

        // ===== RIGHT =====
        .col-lg-8
          .card.card-soft.p-4

            // ===== DETAILS =====
            .row.g-3
              .col-md-6
                label.form-label Author
                input.form-control(readonly value=book.author_name)

              .col-md-6
                label.form-label Publisher
                input.form-control(readonly value=book.publisher_name || "")

              .col-md-6
                label.form-label Publication Date
                input.form-control(type="date" readonly value=book.publication_date_input || "")

              .col-md-6
                label.form-label Cover Image
                input.form-control(readonly value=book.cover_image_url || "")

            .mt-3
              label.form-label Categories
              .d-flex.flex-wrap.gap-2
                each cat in categories
                  if cat.selected
                    span.badge.bg-light.text-dark #{cat.name}

            .mt-3
              label.form-label Description
              textarea.form-control(rows="4" readonly)= book.description || ""

            // ===== ADD REVIEW =====
            if loggedIn && !hasReviewed
              .card.card-soft.p-4.mt-4
                h5.fw-bold.mb-3 Add Your Review
                form(action=`/books/${book.id}/reviews` method="post")
                  .mb-3
                    label.form-label Rating
                    select.form-select(name="rating" required)
                      option(value="") Select
                      each r in [5,4,3,2,1]
                        option(value=r)= '‚≠ê'.repeat(r)
                  .mb-3
                    label.form-label Comment
                    textarea.form-control(name="comment" rows="3")
                  button.btn.btn-primary(type="submit") Submit
            else if loggedIn
              p.text-muted.mt-4 You have already reviewed this book.
            else
              p.text-muted.mt-4 Login to add a review.

            // ===== REVIEWS LIST =====
            .card.card-soft.p-4.mt-4
              h5.fw-bold.mb-3 Reviews

              if reviews && reviews.length
                each review in reviews
                  .border-bottom.pb-3.mb-3
                    .d-flex.justify-content-between
                      strong #{review.username}
                      span ‚≠ê #{review.rating}/5

                    p.mb-1= review.comment
                    small.text-muted Posted on #{review.created_at}

                    if uid === review.user_id
                      details.mt-2
                        summary.text-primary Edit
                        form(action=`/reviews/edit/${review.id}` method="post")
                          input(type="hidden" name="book_id" value=book.id)
                          .mb-2
                            select.form-select.form-select-sm(name="rating" required)
                              each r in [5,4,3,2,1]
                                option(value=r selected=review.rating===r)= '‚≠ê'.repeat(r)
                          .mb-2
                            textarea.form-control.form-control-sm(name="comment" rows="2")= review.comment
                          button.btn.btn-sm.btn-success(type="submit") Save
              else
                p.text-muted No reviews yet.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js")
